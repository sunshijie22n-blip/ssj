# Network layer data plane
## Forwarding and Routing: The Data and Control Planes
Forwarding: 
* When a packet arrives at a router’s input link, the router must move the packet to the appropriate output link.
* Implemented in the data plane

Routing:
* determine the route or path taken by packets as they flow from a
sender to a receiver.
* Implemented in the control plane

## Network Service Model
![alt text](image.png)
The Internet’s network layer provides a single service, known as best-effort service. With best-effort service, packets are neither guaranteed to be received in the order in which they were sent, nor is their eventual delivery even guaranteed. There is no guarantee on the end-to-end delay nor is there a minimal bandwidth guarantee.

## What's inside a router
![alt text](image-1.png)
* Input ports:
1. pysical layer function, teminating an incoming physical link at a router
2. link-layer function
3. look-up function, routing table is consulted. The forwarding table is copied from the routing processor to the line cards over a separate bus (e.g., a PCI bus) indicated by the dashed line from the routing processor to the input line cards in Figure 4.4.

* Switching fabric
* output ports:
1. stores packets received from switching fabric
2. transmits these packets on the outgoing link by performing the necessary link-layer and physical-layer functions
3. When a link is bidirectional (that is, carries traffic in both directions), an output port will typically be paired with the input port for that link on the same line card.
* Routing processor:

performs control-plane functions

In traditional routers
1. executes the routing protocols 
2. maintains routing tables
3. attached link state information
4. computes the forwarding table for the router

In SDN routers
1. responsible for communicating with the remote controller in order to (among other activities) receive forwarding table entries computed by the remote controller
2. install these entries in the router’s input ports

The routing processor also performs the network management functions

Usually, we use prefix in forwarding table to determine which interface this packets should go out through.

When multiple matches exsits, the router uses the longest prefix matching rule.

Although this rule is simple, at Gigabit transmission rates, this lookup must be performed in nanoseconds, so techniques beyond simple linear search through a large table are needed.(refer to p363)

Once a packet's output has been determined via the lookup, the packet can be sent into the fabric.

In some designs, a packet may be temporarily blocked from entering the switching fabric.

A blocked packet will be queued at the input port and then scheduled to cross the fabric later.

Except lookup in input port processing, many other actions must be taken: 

(1) physical- and link-layer processing must occur

(2) the packet’s version number, checksum and time-to-live field—all must be checked and the latter two fields rewritten
  



(3) counters used for network management (such as the number of IP datagrams received) must be updated.

## Switching

Switching can be accomplished in a number of ways.

![alt text](image-2.png)

1. switching via memory: earliest routers were traditional computers. Input and output ports functioned as traditional I/O devices in a traditional operating system. First, An input port with an arriving packet signaled the routing processor via an interrupt. Second, the packet was copied from the input port into processor memory. Finally, the routing processor extracted the destination address from the header, looked up the appropriate output port in the forwarding table, and copied the packet to the output port’s buffers.

In this scenario, if the memory bandwidth is such that a maximum of B packets per second can be written into, or read from, memory, then the overall forwarding throughput (the total rate at which packets are transferred from input ports to output ports) must be less than B/2. Note also that two packets cannot be forwarded at the same time, even if they have different destination ports, since only one memory read/write can be done at a time over the shared system bus.

Some modern routers switch via memory. A major difference from early routers, however, is that the lookup of the destination address and the storing of the packet into the appropriate memory location are performed by processing on the input line cards. In some ways, routers that switch via memory look very much like shared-memory multiprocessors, with the processing on a line card switching (writing) packets into the memory of the appropriate output port. Cisco’s Catalyst 8500 series
switches [Cisco 8500 2016] internally switches packets via a shared memory.

![alt text](image-3.png)

2. Switching via a bus: An input port transfers a packet directly to the output port over a shared bus, without intervention by the routing processor. a. Typically done by having the input port pre-pend a switch-internal label (header) to the packet indicating the local output port to which this packet is being transferred and transmitting the packet onto the bus. b. All output ports receive the packet, but only the port that matches the label will keep the packet. c. The label is then removed at the output port, as this label is only used within the switch to cross the bus. If multiple packets arrive to the router at the same time, each at a different input port, all but one must wait since only one packet can cross the bus at a time, so the switching speed of the router is limited to the bus speed. The Cisco 6500 router[Cisco 6500 2016] internally switches packets over a 32-Gbps-backplane bus.

![alt text](image-4.png)

3. Switching via an interconnection network: A crossbar switch is an interconnection network consisting of 2N buses that connect N input ports to N output ports. Each vertical bus intersects each horizontal bus at a crosspoint, which can be opened or closed at any time by the switch fabric controller (whose logic is part of the switching fabric itself). Unlike the previous two switching approaches, crossbar switches are capable of forwarding multiple packets in parallel. A crossbar switch is non-blocking—a packet being forwarded to an output port will not be blocked from reaching that output port as long as no other packet is currently being forwarded to that output port. Cisco 12000 series switches [Cisco 12000 2016] use a crossbar switching network; the Cisco 7600 series can be configured to use either a bus or crossbar switch [Cisco 7600 2016]. A router’s switching capacity can also be scaled by running multiple switching fabrics in parallel. In this approach, input ports and output ports are connected to N switching fabrics that operate in parallel. An input port breaks a packet into K smaller chunks, and sends (“sprays”) the chunks through K of these N switching fabrics to the selected output port, which reassembles the K chunks back into the original packet.

## Output Port Processing

![alt text](image-5.png)

Output port processing, shown in Figure 4.7, takes packets that have been stored in the output port’s memory and transmits them over the output link. This includes selecting and de-queueing packets for transmission, and performing the needed link-layer and physical-layer transmission functions.

# Network plane Control plane

## Intra-AS Routing in the Internet: OSPF

To the issue of **scale** and **administrative autonomy**, routers can be solved into **autonomous systems(ASs)**. 

An autonomous system is identified by its globally unique autonomous system number (ASN) assigned by ICANN regional registries, same as IP address.

The routing algorithm ­running within an autonomous system is called an intra-autonomous system routing ­protocol(all routers in the same AS run the same algorithm).

OSPF:
1. link-state protocol
2. use flooding of link-state information
3. use Dijkstra’s least-cost path algorithm
4. each router constructs a complete topological map
5. each router locally runs Dijkstra’s shortest-path algorithm
6. individual link costs are configured by the network administrator

About link costs:
1. set all link costs to 1, thus achieving minimum-hop routing
2. inversely proportional to link capacity in order to discourage traffic from using low-bandwidth links

About broadcast:
1. a router broadcasts routing information to all other routers in the autonomous system
2. router broadcasts link-state information whenever there is a change in a link’s state
3. also broadcasts a link’s state periodically (at least once every 30 minutes)
4. OSPF advertisements are contained in OSPF messages that are carried directly by IP, with an upper-layer protocol of 89 for OSPF. Thus, the OSPF protocol must itself implement functionality such as reliable message transfer and link-state broadcast.
5. OSPF protocol also checks that links are operational (via a HELLO message that is sent to an attached neighbor)
6. allows an OSPF router to obtain a neighboring router’s database of network-wide link state

Link-State Database: stored in every OSPF's router, with the information of topology information of the whole AS

Some of the advances embodied in OSPF include the following:

**Security**

Exchanges between OSPF routers (for example, link-state updates) can be authenticated, only trusted routers can participate in the OSPF protocol within an AS. By default, OSPF packets between routers are not authenticated and could be forged. Two types of authentication can be configured: **simple** and **MD5**.

simple: With simple authentication, the same password is configured on each router. When a router sends an OSPF
packet, it includes the password in plaintext. Not secure.

MD5: based on shared secret keys that are configured in all the routers. 1. For each OSPF packet that it sends, the router computes the MD5 hash of the content of the OSPF packet appended with the secret key. 2. The receiving router, using the preconfigured secret key, will compute an MD5 hash of the packet and compare it with the hash value that the packet carries, thus verifying the packet’s authenticity. 3. Sequence numbers are also used with MD5 authentication to protect against replay attacks.

**Multiple same-cost paths**

When multiple paths to a destination have the same cost, OSPF allows multiple paths to be used.

**Integrated support for unicast and multicast routing**

Multicast OSPF (MOSPF) provides simple extensions to OSPF to provide for multicast routing. MOSPF uses the existing
OSPF link database and adds a new type of link-state advertisement to the existing OSPF link-state broadcast mechanism.

**Support for hierarchy within a single AS**

1. An OSPF autonomous system can be configured hierarchically into areas
2. Each area runs its own OSPF link-state routing algorithm, with each router in an area broadcasting its link state to all other routers in that area
3. Within each area, one or more area border routers are responsible for routing packets outside the area
4. Exactly one OSPF area in the AS is configured to be the backbone area. The primary role of the backbone area is to route traffic between the other areas in the AS. The backbone always contains all area border routers in the AS and may contain non-border routers as well.
5. Inter-area routing within the AS requires that the packet be first routed to an area border router (intra-area routing), then routed through the backbone to the area border router that is in the destination area, and then routed to the final destination.
